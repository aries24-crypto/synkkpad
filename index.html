<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Utility Hub with AI Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load html2canvas for converting formatted HTML/Rich Text to canvas/image for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- SYNTAX HIGHLIGHTING (PrismJS) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-autoloader.min.js"></script>
    
    <style>
        /* Hide scrollbar on the editor but allow scrolling */
        #textEditor {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            /* Custom scrollbar for aesthetics */
            scrollbar-width: thin;
            scrollbar-color: #6366f1 #e5e7eb;
            /* Default font for editor, ensures consistency */
            font-family: 'Inter', 'Noto Sans Devanagari', sans-serif;
            font-size: 1rem;
        }
        #textEditor::-webkit-scrollbar {
            width: 8px;
        }
        #textEditor::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 4px;
        }
        #textEditor::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }

        /* Custom styles for better button contrast */
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 transition duration-150 ease-in-out;
        }
        .btn-secondary {
            @apply bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 transition duration-150 ease-in-out;
        }
        
        /* Base style for toolbar buttons: dark gray text by default, simple hover background */
        .toolbar-btn {
            @apply p-2 rounded-lg hover:bg-gray-200 text-gray-800;
        }
        
        /* Style for active buttons: ONLY text color change to red, forcing background to match toolbar (white) to avoid any shadow or tint. */
        .toolbar-active { 
            /* Only change the text color */
            @apply text-red-600; 
            /* Explicitly override any background/shadow to ensure it looks like nothing changed */
            @apply bg-white shadow-none; 
        }

        /* Styling for Prism code blocks within the contenteditable area */
        #textEditor pre {
            @apply my-4 p-4 rounded-lg overflow-x-auto;
            /* Use Prism theme background color */
            background-color: #272822 !important; 
        }

        /* Ensure code text color contrasts with the dark background */
        #textEditor pre code {
            font-family: monospace;
            color: #f8f8f2 !important;
        }

        /* --- VIRTUAL KEYBOARD STYLES --- */
        .keyboard-key {
            @apply flex items-center justify-center p-2 rounded-lg bg-white shadow-md hover:bg-indigo-100 transition duration-150 cursor-pointer select-none text-xl font-medium;
            height: 50px;
            min-width: 40px;
            flex-grow: 1;
            font-family: 'Noto Sans Devanagari', 'Inter', sans-serif;
            font-size: 1.2rem; /* Larger font for keys */
        }
        .space-key {
            flex-grow: 5;
            @apply bg-gray-200 hover:bg-gray-300;
        }
        .control-key {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-semibold;
            flex-grow: 1.5;
            font-size: 0.875rem;
        }
        .shift-active {
            @apply !bg-indigo-900;
        }

        /* Style for selected images to provide a visual cue */
        .image-selected {
            outline: 2px solid #6366f1;
            outline-offset: 4px;
            cursor: pointer;
        }
    </style>
    <script>
        // Set up Tailwind configuration for custom colors and font
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#6366f1',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-7xl mx-auto relative">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">SYNKPAD</h1>
            <h4>BY THE <strong>3aMARCHive</strong></h4>
            <p class="text-lg text-gray-600">Rich Editing, Counting, Converting, and Advanced PDF Generation.</p>
        </header>

        <!-- Status Message Box -->
        <div id="statusMessage" class="hidden fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl z-50 transition-all duration-300"></div>

        <!-- Image Control Panel (Floating) -->
        <div id="imageControls" class="hidden absolute bg-white p-3 rounded-xl shadow-2xl border border-indigo-300 z-40" style="min-width: 250px;">
            <h4 class="text-sm font-bold text-gray-700 mb-2 border-b pb-1">Image Editor</h4>
            <div class="flex flex-wrap gap-2 mb-3 items-center">
                <!-- Alignment Controls -->
                <button onclick="alignSelectedImage('left')" class="toolbar-btn text-sm p-1.5" title="Align Left (Float)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm0 7h12v2H3zm0 7h18v2H3z"/></svg>
                </button>
                <button onclick="alignSelectedImage('center')" class="toolbar-btn text-sm p-1.5" title="Center (Block)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z"/></svg>
                </button>
                <button onclick="alignSelectedImage('right')" class="toolbar-btn text-sm p-1.5" title="Align Right (Float)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm0 7h12v2H3zm0 7h18v2H3z"/></svg>
                </button>
                <div class="border-l border-gray-300 h-6 mx-1"></div>
                <!-- Delete Button -->
                <button onclick="deleteSelectedImage()" class="toolbar-btn text-sm p-1.5 text-red-500 hover:bg-red-100" title="Delete Image">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>

            <!-- Resizing Controls -->
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <label class="text-xs font-medium text-gray-500">Width (%)</label>
                    <input type="number" id="imageWidth" min="10" max="100" step="5" oninput="resizeSelectedImage()" class="w-16 p-1 border rounded text-xs text-right focus:ring-indigo-500">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-xs font-medium text-gray-500">Reset Size</label>
                    <button onclick="resetImageSize()" class="btn-secondary py-1 px-3 text-xs rounded shadow-sm">
                        100%
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Rich Text Toolbar -->
        <div class="bg-white p-4 rounded-t-xl border border-indigo-200 shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-3">Rich Text Editor Controls</h2>
            <div class="flex flex-wrap gap-2 items-center">
                <!-- Formatting Buttons -->
                <button id="boldBtn" onclick="execCmd('bold')" class="toolbar-btn font-bold" title="Bold">B</button>
                <button id="italicBtn" onclick="execCmd('italic')" class="toolbar-btn italic" title="Italic">I</button>
                <button id="underlineBtn" onclick="execCmd('underline')" class="toolbar-btn underline" title="Underline">U</button>
                <button id="strikethroughBtn" onclick="execCmd('strikethrough')" class="toolbar-btn line-through" title="Strikethrough">S</button>
                
                <!-- Subscript and Superscript Buttons -->
                <button id="superscriptBtn" onclick="execCmd('superscript')" class="toolbar-btn" title="Superscript">
                    X<sup class="text-sm">2</sup>
                </button>
                <button id="subscriptBtn" onclick="execCmd('subscript')" class="toolbar-btn" title="Subscript">
                    X<sub class="text-sm">2</sub>
                </button>

                <!-- Alignment -->
                <button id="leftBtn" onclick="execCmd('justifyLeft')" class="toolbar-btn" title="Align Left">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm0 7h12v2H3zm0 7h18v2H3z"/></svg>
                </button>
                <button id="centerBtn" onclick="execCmd('justifyCenter')" class="toolbar-btn" title="Align Center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm0 7h18v2H3zm0 7h18v2H3z"/></svg>
                </button>
                <button id="rightBtn" onclick="execCmd('justifyRight')" class="toolbar-btn" title="Align Right">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3zm0 7h12v2H3zm0 7h18v2H3z"/></svg>
                </button>

                <!-- Color Picker -->
                <input type="color" id="colorPicker" value="#000000" onchange="execCmd('foreColor', this.value)" class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer" title="Text Color">

                <!-- Font Size Slider (Updated) -->
                <div class="flex items-center space-x-2">
                    <label for="fontSizeSlider" class="text-sm text-gray-600 font-medium whitespace-nowrap">Font Size:</label>
                    <input type="range" id="fontSizeSlider" min="1" max="100" value="16" step="1" 
                        oninput="updateFontSize(this.value)" 
                        class="h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer w-24">
                    <span id="fontSizeValue" class="text-sm font-medium text-indigo-700 w-12 text-right">16pt</span>
                </div>

                <div class="border-l border-gray-300 h-8 mx-2"></div>
                
                <!-- CODE HIGHLIGHTING CONTROLS -->
                <label for="languageSelect" class="text-sm text-gray-600 font-medium whitespace-nowrap">Code Language:</label>
                <select id="languageSelect" class="p-2 border rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="autodetect">Auto Detect</option>
                    <option value="javascript">JavaScript</option>
                    <option value="css">CSS</option>
                    <option value="html">HTML</option>
                    <option value="python">Python</option>
                    <option value="clike">C-like (C, C++, Java)</option>
                </select>

                <button onclick="highlightCode()" class="btn-secondary py-2 px-4 font-medium shadow-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                    Highlight Code
                </button>

                <!-- End Code Controls -->
                <div class="border-l border-gray-300 h-8 mx-2"></div>

                <!-- Image Attachment and Copy -->
                <label for="imageUpload" class="toolbar-btn cursor-pointer flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-12 5h12a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    Attach Image
                    <input type="file" id="imageUpload" accept="image/jpeg, image/png" onchange="insertImage(this)" class="hidden">
                </label>
                
                <button onclick="copyText()" class="btn-secondary py-2 px-4 ml-auto font-medium shadow-sm">
                    Copy Text/HTML
                </button>
            </div>
        </div>

        <!-- Main Rich Text Editor -->
        <div 
            id="textEditor"
            contenteditable="true"
            oninput="updateCounts(); hideImageControls();"
            onmouseup="updateToolbarState(); hideImageControls();"
            onkeyup="updateToolbarState(); hideImageControls();"
            onclick="handleEditorClick(event);"
            onpaste="handlePasteCleanup(event);"
            class="w-full h-96 p-6 text-base text-gray-800 border-4 border-t-0 border-indigo-500 focus:ring-4 focus:ring-indigo-700 rounded-b-xl resize-none outline-none bg-white shadow-2xl"
        >
            <p><strong>Welcome!</strong> Start typing and use the controls above to format your text. You can use the Hindi Keyboard below to type in Devanagari. Click on an image to edit its size and position.</p>
            <pre><code class="language-javascript">function getLanguageStatus(text) {
  // Try writing something in Hindi, German, or Japanese here!
  return text.length > 0;
}</code></pre>
            <!-- Add some dummy content to make the editor scrollable for testing the fix -->
            <p><br>More content for scroll test...</p>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer nec odio. Praesent libero. Sed cursus ante dapibus diam. Sed nisi. Nulla quis sem at nibh elementum imperdiet. Duis sagittis ipsum. Praesent mauris. Fusce nec tellus sed augue semper porta. Mauris massa. Vestibulum lacinia arcu eget nulla. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Curabitur sodales ligula in libero. Sed dignissim lacinia nunc. Curabitur tortor. Pellentesque nibh. Aenean quam. In scelerisque sem at dolor. Maecenas mattis. Sed convallis tristique sem. Proin ut ligula vel nunc egestas porttitor. Morbi lectus risus, iaculis vel, suscipit quis, vitae, nonummy.</p>
        </div>

        <!-- NEW: Hindi Virtual Keyboard Section -->
        <div class="mt-8 bg-gray-100 p-4 rounded-xl shadow-xl border border-gray-300">
            <details>
                <summary class="cursor-pointer font-bold text-lg text-indigo-700 hover:text-indigo-900 transition-colors flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 4a2 2 0 10-4 0v12a2 2 0 104 0V4zM16 3h-2v14h2M5 19h14M8 17h8"/></svg>
                    Hindi (Devanagari) Virtual Keyboard
                </summary>
                <div id="keyboard" class="mt-4">
                    <!-- Keyboard layout generated by JavaScript -->
                </div>
            </details>
        </div>


        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">

            <!-- 1. Word Counter Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Word Counter
                </h2>
                <div class="grid grid-cols-2 gap-4 text-center" id="counterResults">
                    <!-- Stat Card -->
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <div class="text-xl font-extrabold text-indigo-600" id="wordCount">0</div>
                        <div class="text-sm text-gray-500">Words</div>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <div class="text-xl font-extrabold text-indigo-600" id="charCount">0</div>
                        <div class="text-sm text-gray-500">Characters</div>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <div class="text-xl font-extrabold text-indigo-600" id="lineCount">0</div>
                        <div class="text-sm text-gray-500">Lines</div>
                    </div>
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <div class="text-xl font-extrabold text-indigo-600" id="sentenceCount">0</div>
                        <div class="text-sm text-gray-500">Sentences</div>
                    </div>
                </div>
                <!-- Basic Grammar/Semantic Checker Output (LSP Stand-in) -->
                <div id="grammarWarnings" class="mt-4 p-2 text-sm bg-red-100 text-red-700 rounded-lg hidden">
                    <p class="font-bold">Basic English Grammar Warning:</p>
                    <ul id="grammarList" class="list-disc list-inside mt-1"></ul>
                </div>
            </div>

            <!-- 2. Text Case Converter & Cleaner -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                    Converter & Cleaner
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="convertToCase('uppercase')" class="btn-primary py-3 px-4 rounded-lg font-medium shadow-md">
                        UPPER CASE
                    </button>
                    <button onclick="convertToCase('lowercase')" class="btn-primary py-3 px-4 rounded-lg font-medium shadow-md">
                        lower case
                    </button>
                    <button onclick="convertToCase('titlecase')" class="btn-primary py-3 px-4 rounded-lg font-medium shadow-md">
                        Title Case
                    </button>
                    <button onclick="convertToCase('sentencecase')" class="btn-primary py-3 px-4 rounded-lg font-medium shadow-md">
                        Sentence case
                    </button>
                    <button onclick="cleanWhitespace()" class="btn-secondary col-span-2 py-3 px-4 rounded-lg font-medium shadow-md">
                        Remove Extra Whitespace
                    </button>
                </div>
            </div>

            <!-- 3. Find and Replace Tool -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Find & Replace
                </h2>
                <div class="space-y-3">
                    <input type="text" id="findTerm" placeholder="Find what..." class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <input type="text" id="replaceTerm" placeholder="Replace with..." class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <button onclick="findAndReplace()" class="btn-primary w-full py-3 px-4 rounded-lg font-medium shadow-md">
                        Replace All Instances
                    </button>
                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="caseSensitive" class="rounded text-indigo-600 focus:ring-indigo-500">
                            <span>Case Sensitive</span>
                        </label>
                        <span id="replaceCount" class="font-medium">0 replacements</span>
                    </div>
                </div>
            </div>


            <!-- 4. PDF Converter Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Advanced PDF Generator
                </h2>

                <div class="space-y-4">
                    <p class="text-sm text-gray-600">
                        This converts the fully formatted content (text, code blocks, images) into a multi-page PDF document.
                    </p>
                    <button onclick="generateRichTextPDF()" class="btn-primary w-full py-3 px-4 rounded-lg font-medium shadow-md">
                        Download Rich Text/Image as PDF
                    </button>
                    <p class="text-sm text-gray-500 pt-2 border-t mt-4">
                        (Legacy) Convert a single local Image (JPEG/PNG) to PDF:
                    </p>
                    <input type="file" id="imageInput" accept="image/jpeg, image/png" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                        file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100"/>
                        
                    <button onclick="generateImagePDF()" id="imagePdfButton" class="btn-primary w-full py-3 px-4 rounded-lg font-medium shadow-md disabled:bg-indigo-400" disabled>
                        Convert Image to PDF
                    </button>
                </div>

            </div>

        </div>

        <!-- Multilingual AI Assistant (Full Width) -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-2xl border-4 border-indigo-600">
            <h2 class="text-2xl font-extrabold text-indigo-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                Multilingual AI Assistant (Semantic Analysis & Translation)
            </h2>
            <p class="text-gray-600 mb-4">
                Analyzes the text in the editor to identify the language, provides a translation, and suggests semantic improvements.
            </p>
            
            <button onclick="runMultilingualAnalysis()" id="aiAnalysisButton" class="btn-primary py-3 px-6 rounded-lg font-bold w-full md:w-auto shadow-lg">
                <span id="aiButtonText">Run Multilingual Analysis</span>
                <span id="aiSpinner" class="hidden ml-2 inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-white border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></span>
            </button>
            
            <div id="aiResponseContainer" class="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200 hidden">
                <p class="text-lg font-semibold text-indigo-800 mb-2">Analysis Results:</p>
                <div id="aiResponseContent" class="prose max-w-none">
                    <!-- AI response will be injected here -->
                </div>
            </div>
        </div>
    </div>
<p style="
  max-width: 720px;
  margin: 40px auto;
  padding: 16px 20px;
  text-align: center;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  font-size: 14px;
  line-height: 1.55;
  color: #0f172a;
  background: rgba(0,0,0,0.04);
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  letter-spacing: 0.3px;
">
  <strong style="font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#0a0f1c;">
    © 2025 SYNKPAD — The 3aMARCHive
  </strong><br><br>
  SYNCPAD is a FREE, NON-PROFIT, Lightweight, privacy-first text utilities built for speed and simplicity. 
  No accounts, no storage — everything runs locally in your browser.<br>
  For feedback or suggestions, reach out on Instagram:
  <a href="https://instagram.com/the3am_archive" target="_blank" 
     style="font-weight:600; text-decoration:none; color:#0f172a;">
     @the3am_archive
  </a>.
</p>

    <script type="text/javascript">
        // Helper to get element by ID
        const $ = id => document.getElementById(id);

        const textEditor = $('textEditor');
        const languageSelect = $('languageSelect');
        const imageInput = $('imageInput');
        const imagePdfButton = $('imagePdfButton');
        const statusMessage = $('statusMessage');
        const findTermInput = $('findTerm');
        const replaceTermInput = $('replaceTerm');
        const caseSensitiveCheckbox = $('caseSensitive');
        const replaceCountSpan = $('replaceCount');
        const aiAnalysisButton = $('aiAnalysisButton');
        const aiButtonText = $('aiButtonText');
        const aiSpinner = $('aiSpinner');
        const aiResponseContainer = $('aiResponseContainer');
        const aiResponseContent = $('aiResponseContent');
        const keyboardDiv = $('keyboard');
        const imageControls = $('imageControls');
        const imageWidthInput = $('imageWidth');
        
        // --- GLOBAL STATE ---
        let isShifted = false; // State to track if the Shift key is active
        let currentImage = null; // Currently selected image element for editing

        // The API Key for the Gemini API call
        const apiKey = ""; 

        // Toolbar buttons mapping for state tracking 
        const formattingButtons = {
            'bold': $('boldBtn'),
            'italic': $('italicBtn'),
            'underline': $('underlineBtn'),
            'strikethrough': $('strikethroughBtn'),
            'superscript': $('superscriptBtn'),
            'subscript': $('subscriptBtn'),
            'justifyLeft': $('leftBtn'),
            'justifyCenter': $('centerBtn'),
            'justifyRight': $('rightBtn'),
        };

        // --- GLOBAL UTILITIES ---
        let messageTimeout;

        function showMessage(msg, type = 'success') {
            clearTimeout(messageTimeout);
            statusMessage.textContent = msg;
            statusMessage.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl z-50 transition-all duration-300 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} block`;
            
            messageTimeout = setTimeout(() => {
                hideMessage();
            }, 3000);
        }

        function hideMessage() {
            statusMessage.classList.add('hidden');
        }


        // --- PASTE CLEANUP (SUPER IMPORTANT) ---
        function handlePasteCleanup(event) {
            // 1. Prevent the default rich-text paste behavior
            event.preventDefault();

            // 2. Get the plain text data from the clipboard
            const clipboardData = event.clipboardData || window.clipboardData;
            let pastedText = clipboardData.getData('text/plain');

            // 3. Cleanup logic (weird spacing, line breaks, invisible chars, formatting tags)
            
            // a. Replace invisible/non-standard spaces with a regular space
            // \u200B (Zero-width space), \uFEFF (BOM), \u00A0 (Non-breaking space)
            pastedText = pastedText.replace(/[\u200B\uFEFF\u00A0]/g, ' ');

            // b. Normalize multiple spaces to a single space
            pastedText = pastedText.replace(/[ ]+/g, ' ');
            
            // c. Normalize line endings (CRLF, CR) to simple newline (\n)
            pastedText = pastedText.replace(/\r\n|\r/g, '\n');

            // d. Reduce excessive consecutive newlines (3 or more) to a maximum of two
            pastedText = pastedText.replace(/\n{3,}/g, '\n\n');
            
            // e. Trim leading/trailing whitespace
            pastedText = pastedText.trim();
            
            // 4. Insert the cleaned text at the cursor
            document.execCommand('insertText', false, pastedText);
            
            updateCounts();
            showMessage("Pasted content cleaned up (HTML and garbage characters removed)!", 'success');
        }


        // --- RICH TEXT EDITOR CONTROLS ---

        // Executable command for Rich Text Editor
        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
            textEditor.focus();
            updateToolbarState();
        }
        
        // Function to update the visual state of toolbar buttons (Icon-only highlight)
        function updateToolbarState() {
            for (const cmd in formattingButtons) {
                const button = formattingButtons[cmd];
                let isActive = false;

                if (cmd.startsWith('justify')) {
                    isActive = document.queryCommandValue(cmd) === 'true';

                    if (cmd === 'justifyLeft') {
                        const isCenter = document.queryCommandValue('justifyCenter') === 'true';
                        const isRight = document.queryCommandValue('justifyRight') === 'true';
                        if (!isCenter && !isRight) {
                            isActive = true;
                        }
                    }

                } else {
                    isActive = document.queryCommandState(cmd);
                }

                button.classList.toggle('toolbar-active', isActive);
            }
        }

        // Font Size Slider Logic
        function updateFontSize(size) {
            const sizeValueDisplay = $('fontSizeValue');
            sizeValueDisplay.textContent = `${size}pt`;
            
            // Map pt to HTML font size command values (1-7) for cross-browser compatibility
            let mappedSize;
            if (size < 12) mappedSize = 1;
            else if (size < 16) mappedSize = 2;
            else if (size < 24) mappedSize = 3;
            else if (size < 36) mappedSize = 4;
            else if (size < 48) mappedSize = 5;
            else if (size < 72) mappedSize = 6;
            else mappedSize = 7;

            document.execCommand('fontSize', false, mappedSize);
            textEditor.focus();
        }

        // Image Insertion Logic
        function insertImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.width = '100%'; // Default to full width
                img.alt = file.name;
                img.setAttribute('draggable', 'false'); // Prevent dragging from contenteditable
                // NOTE: Click handler is now managed by handleEditorClick for robustness

                textEditor.focus();
                // Ensure image is inserted at the caret position
                document.execCommand('insertHTML', false, img.outerHTML);
                input.value = '';
                showMessage("Image attached successfully! Click on it to edit size/position.");
            };
            reader.readAsDataURL(file);
        }

        // --- IMAGE EDITING CONTROLS ---

        // Function to find the nearest img element ancestor
        function getSelectedImage(target) {
            if (target && target.tagName === 'IMG') {
                return target;
            }
            return null;
        }

        function showImageControls(img) {
            // Remove selection class from old image if it exists and is different
            if (currentImage && currentImage !== img) {
                currentImage.classList.remove('image-selected');
            }
            
            currentImage = img;
            currentImage.classList.add('image-selected');

            // --- CRITICAL FIX: Positioning now accounts for editor's scroll ---
            const rect = currentImage.getBoundingClientRect();
            const editorRect = textEditor.getBoundingClientRect();
            const controlsRect = imageControls.getBoundingClientRect();

            // Calculate position relative to the editor's content (including scroll)
            // (Image visual top - Editor visual top) + Editor scroll position
            let topPos = (rect.top - editorRect.top) + textEditor.scrollTop - controlsRect.height - 10;
            
            // Horizontal centering relative to the image
            let leftPos = rect.left - editorRect.left + (rect.width / 2) - (controlsRect.width / 2);
            
            // Ensure controls stay inside the visible editor area horizontally
            leftPos = Math.max(10, Math.min(leftPos, editorRect.width - controlsRect.width - 10));

            imageControls.style.top = `${topPos}px`;
            imageControls.style.left = `${leftPos}px`;
            imageControls.classList.remove('hidden');

            // Update the width input field based on the current image size
            let currentWidth = currentImage.style.width || '100%';
            currentWidth = parseInt(currentWidth.replace('%', ''));
            imageWidthInput.value = currentWidth;
        }

        function hideImageControls() {
            imageControls.classList.add('hidden');
            if (currentImage) {
                currentImage.classList.remove('image-selected');
                currentImage = null;
            }
        }

        function handleEditorClick(event) {
            const target = event.target;
            const img = getSelectedImage(target);

            // 1. If an image was clicked, show controls for it
            if (img) {
                event.stopPropagation(); // Stop editor default behavior
                showImageControls(img);
                return;
            }

            // 2. If the click was outside the editor AND the control panel, hide controls
            if (!imageControls.contains(target)) {
                hideImageControls();
            }
        }
        
        // Listen for scroll events on the editor to reposition controls if visible
        textEditor.addEventListener('scroll', () => {
            if (currentImage) {
                // Re-run the positioning logic on scroll
                showImageControls(currentImage);
            }
        });


        function resizeSelectedImage() {
            if (!currentImage) return;

            let width = parseInt(imageWidthInput.value);
            if (isNaN(width) || width < 10 || width > 100) {
                showMessage("Width must be between 10% and 100%.", 'error');
                return;
            }
            
            currentImage.style.width = `${width}%`;
            currentImage.style.maxWidth = '100%'; 
            
            // Reposition controls after resize
            setTimeout(() => {
                showImageControls(currentImage);
            }, 50);
        }

        function resetImageSize() {
            if (!currentImage) return;
            imageWidthInput.value = 100;
            resizeSelectedImage();
            showMessage("Image size reset to 100%.");
        }

        function alignSelectedImage(alignment) {
            if (!currentImage) return;

            // Clear previous alignment styles
            currentImage.style.float = '';
            currentImage.style.margin = '10px 0'; // Restore vertical margin
            currentImage.style.display = 'block';

            switch (alignment) {
                case 'left':
                    currentImage.style.float = 'left';
                    currentImage.style.margin = '10px 10px 10px 0';
                    currentImage.style.display = 'inline-block'; // Allow text wrapping
                    break;
                case 'center':
                    // To truly center an image in contenteditable, it needs block display and auto margins
                    currentImage.style.margin = '10px auto';
                    currentImage.style.display = 'block';
                    break;
                case 'right':
                    currentImage.style.float = 'right';
                    currentImage.style.margin = '10px 0 10px 10px';
                    currentImage.style.display = 'inline-block'; // Allow text wrapping
                    break;
            }

            showMessage(`Image aligned to ${alignment}.`);
            // Reposition controls after alignment change
            setTimeout(() => {
                showImageControls(currentImage);
            }, 50);
        }

        function deleteSelectedImage() {
            if (!currentImage) return;
            
            currentImage.remove();
            hideImageControls();
            showMessage("Image deleted.");
            updateCounts();
        }
        
        // --- SYNTAX HIGHLIGHTING LOGIC ---

        function highlightCode() {
            const langValue = languageSelect.value;
            const langClass = langValue === 'autodetect' ? 'language-auto' : `language-${langValue}`;

            const selection = window.getSelection();
            if (selection.rangeCount === 0) {
                showMessage("Please select the code block you wish to highlight.", 'error');
                return;
            }

            const range = selection.getRangeAt(0);
            const content = range.extractContents();

            const code = document.createElement('code');
            code.className = langClass;
            code.textContent = content.textContent || content.innerText; 
            
            const pre = document.createElement('pre');
            pre.appendChild(code);

            range.insertNode(pre);

            setTimeout(() => {
                Prism.highlightAll();
                showMessage(`Code highlighted! Language: ${langValue}`);
                textEditor.focus();
            }, 50); 
        }

        // --- 1. WORD COUNTER & BASIC GRAMMAR CHECKER (LSP Stand-in) ---

        // Simple check for common English errors
        function runBasicGrammarCheck(text) {
            const warnings = [];
            const lowerText = text.toLowerCase();

            // 1. "Their/There/They're"
            if (lowerText.includes('their') && !text.includes('Their')) warnings.push("Check usage of 'their', 'there', and 'they're'.");
            if (lowerText.includes('then') && !lowerText.includes('than')) warnings.push("Review 'then' vs 'than' usage for comparisons.");
            if (lowerText.includes('it\'s') && !lowerText.includes('its')) warnings.push("Review 'it's' vs 'its' usage for possession.");
            
            // 2. Fragment Check (simple heuristic: starts with conjunction and no verb)
            const fragmentRegex = /^(and|but|or|so|because|although)\s+[^,;]*\s*$/i;
            if (text.split(/[.!?]/).some(sentence => fragmentRegex.test(sentence.trim()))) {
                 warnings.push("Potential sentence fragment detected (starts with conjunction).");
            }

            const warningsDiv = $('grammarWarnings');
            const warningsList = $('grammarList');
            
            warningsList.innerHTML = '';

            if (warnings.length > 0) {
                warnings.forEach(w => {
                    const li = document.createElement('li');
                    li.textContent = w;
                    warningsList.appendChild(li);
                });
                warningsDiv.classList.remove('hidden');
            } else {
                warningsDiv.classList.add('hidden');
            }
        }


        function updateCounts() {
            // Use innerText to get clean, unformatted text
            const text = textEditor.innerText;
            const charCount = text.length;
            $('charCount').textContent = charCount;

            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            const wordCount = words.length;
            $('wordCount').textContent = wordCount;

            const lineCount = text.split('\n').length;
            // Only count lines if there's actual content
            $('lineCount').textContent = charCount > 0 ? lineCount : 0; 

            // Simple sentence detection (end with . ! ?)
            const sentenceMatches = text.trim().match(/[.!?]+(?:\s|$)/g);
            const sentenceCount = sentenceMatches ? sentenceMatches.length : 0;
            $('sentenceCount').textContent = sentenceCount;

            // Run Basic Grammar Check (LSP Stand-in)
            runBasicGrammarCheck(text);
        }


        // --- MULTILINGUAL AI ASSISTANT (GEMINI API) ---
        
        async function callGemini(userQuery, maxRetries = 5) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `You are a Multilingual Text Analyzer. The user will provide raw text. Your task is to perform a detailed analysis of the text based on this list of supported languages: English, Hindi, German, French, Spanish, Punjabi, Marathi, Tamil, Bengali, Telegu, Urdu, Arabic, Korean, Chinese, and Japanese.

            Your response MUST be formatted strictly in Markdown and include these three distinct sections:
            
            ### 1. Language Identification
            State the detected language. If the language is not in the supported list, state "Unsupported/Unknown Language."
            
            ### 2. Semantic Analysis & Clarity Suggestions
            Provide a short paragraph offering suggestions for grammar, tone, flow, and clarity. This acts as a powerful, context-aware grammar/semantic checker.
            
            ### 3. English Translation
            Provide a clear and accurate translation of the text into English. If the source text is already English, state: "Source text is already in English."
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        // Rate limit hit, apply exponential backoff
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text;
                    } else {
                        throw new Error("Invalid response structure from API.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) {
                        throw new Error("Failed to connect to AI after multiple retries.");
                    }
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        async function runMultilingualAnalysis() {
            const text = textEditor.innerText.trim();
            if (!text) {
                showMessage("The editor is empty. Please enter text to analyze.", 'error');
                return;
            }

            // UI feedback: disable button and show spinner
            aiAnalysisButton.disabled = true;
            aiButtonText.textContent = "Analyzing...";
            aiSpinner.classList.remove('hidden');
            aiResponseContainer.classList.add('hidden');
            aiResponseContent.innerHTML = '';
            
            showMessage("Sending text for AI analysis...", 'success');

            try {
                const analysisResult = await callGemini(text);

                // Simple Markdown parser implementation (as full marked library is external)
                aiResponseContent.innerHTML = marked(analysisResult); 
                aiResponseContainer.classList.remove('hidden');
                showMessage("Analysis complete!");

            } catch (error) {
                console.error(error);
                aiResponseContent.innerHTML = `<p class="text-red-600">Error: Could not complete analysis. ${error.message}</p>`;
                aiResponseContainer.classList.remove('hidden');
                showMessage("AI analysis failed.", 'error');
            } finally {
                // UI feedback: re-enable button and hide spinner
                aiAnalysisButton.disabled = false;
                aiButtonText.textContent = "Run Multilingual Analysis";
                aiSpinner.classList.add('hidden');
            }
        }

        // Simple Markdown parser function (Must be self-contained)
        function marked(markdownText) {
            let html = markdownText
                .replace(/^### (.*$)/gim, '<h3>$1</h3>') // H3
                .replace(/^## (.*$)/gim, '<h2>$1</h2>') // H2
                .replace(/^# (.*$)/gim, '<h1>$1</h1>') // H1
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>') // Bold
                .replace(/\*(.*)\*/gim, '<em>$1</em>') // Italic
                .replace(/\n/g, '<br>');
            return html;
        }

        // --- 2. TEXT CASE CONVERTER & CLEANER LOGIC ---
        function toTitleCase(str) {
            return str.toLowerCase().split(' ').map(function(word) {
                if (word.length === 0) return '';
                return (word.charAt(0).toUpperCase() + word.slice(1));
            }).join(' ');
        }

        function toSentenceCase(str) {
            return str.toLowerCase().replace(/(^\s*\w|[.?!]\s*\w)/g, function(c) {
                return c.toUpperCase();
            });
        }

        function convertToCase(caseType) {
            let text = textEditor.innerText;
            let convertedText = text;

            switch (caseType) {
                case 'uppercase': convertedText = text.toUpperCase(); break;
                case 'lowercase': convertedText = text.toLowerCase(); break;
                case 'titlecase': convertedText = toTitleCase(text); break;
                case 'sentencecase': convertedText = toSentenceCase(text); break;
                default: return;
            }

            textEditor.innerHTML = convertedText;
            updateCounts();
            showMessage(`Text successfully converted to ${caseType.replace('case', '')}! (Formatting lost)`);
        }

        function cleanWhitespace() {
            let text = textEditor.innerText;
            text = text.replace(/ {2,}/g, ' '); 
            text = text.split('\n').map(line => line.trim()).join('\n');
            text = text.replace(/(\n\s*){2,}/g, '\n\n'); 
            
            textEditor.innerHTML = text.trim();
            updateCounts();
            showMessage("Whitespace cleaned up! (Formatting lost)");
        }

        function copyText() {
            const text = textEditor.innerText;
            if (!text) {
                showMessage("Nothing to copy!", 'error');
                return;
            }
            try {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                document.execCommand('copy');
                showMessage("Text copied to clipboard!");
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage("Failed to copy text.", 'error');
            }
        }

        // --- 3. FIND AND REPLACE LOGIC ---
        function findAndReplace() {
            const findTerm = findTermInput.value;
            const replaceTerm = replaceTermInput.value;
            const caseSensitive = caseSensitiveCheckbox.checked;
            
            if (!findTerm) {
                showMessage("Please enter a term to find.", 'error');
                return;
            }

            let content = textEditor.innerHTML;

            const flags = 'g' + (caseSensitive ? '' : 'i');
            const regex = new RegExp(escapeRegExp(findTerm), flags);

            const matches = content.match(regex);
            const count = matches ? matches.length : 0;

            if (count === 0) {
                showMessage(`No instances of "${findTerm}" found.`, 'error');
                replaceCountSpan.textContent = "0 replacements";
                return;
            }

            const newContent = content.replace(regex, replaceTerm);

            textEditor.innerHTML = newContent;
            updateCounts();
            replaceCountSpan.textContent = `${count} replacement${count === 1 ? '' : 's'}`;
            showMessage(`Successfully replaced ${count} instance${count === 1 ? '' : 's'}!`);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }


        // --- 4. ADVANCED PDF GENERATOR LOGIC ---
        const { jsPDF } = window.jspdf;

        async function generateRichTextPDF() {
            const editorDiv = textEditor;
            const content = editorDiv.innerText;

            if (!content.trim()) {
                showMessage("Editor is empty. Cannot generate PDF.", 'error');
                return;
            }

            showMessage("Generating PDF... Please wait.");

            try {
                Prism.highlightAll();

                // Temporarily clone the editor content to ensure the selection outline isn't captured
                const tempDiv = editorDiv.cloneNode(true);
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.width = editorDiv.offsetWidth + 'px'; // Maintain width
                // Remove selection class from any images in the clone
                tempDiv.querySelectorAll('.image-selected').forEach(img => img.classList.remove('image-selected'));
                document.body.appendChild(tempDiv);


                const canvas = await html2canvas(tempDiv, {
                    scale: 2, 
                    logging: false,
                    useCORS: true
                });

                document.body.removeChild(tempDiv); // Remove temporary div

                const imgData = canvas.toDataURL('image/png');
                const doc = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();

                const imgHeight = canvas.height * pdfWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }

                doc.save(`rich-text-document-${Date.now()}.pdf`);
                showMessage("Formatted PDF generated successfully!");

            } catch (e) {
                console.error("Advanced PDF Generation Error:", e);
                showMessage("Error generating formatted PDF. Try removing large images.", 'error');
            }
        }

        // --- 5. LEGACY IMAGE TO PDF LOGIC ---
        
        imageInput.addEventListener('change', () => {
            imagePdfButton.disabled = !imageInput.files.length;
        });

        function generateImagePDF() {
            const file = imageInput.files[0];

            if (!file) {
                showMessage("Please select an image file first.", 'error');
                return;
            }

            showMessage("Converting image to PDF...");

            const reader = new FileReader();
            reader.onload = function(e) {
                const imgData = e.target.result;

                try {
                    const doc = new jsPDF();
                    const img = new Image();
                    img.src = imgData;

                    img.onload = function() {
                        const imgWidth = img.width;
                        const imgHeight = img.height;
                        const ratio = imgWidth / imgHeight;
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = doc.internal.pageSize.getHeight();

                        let finalWidth = pdfWidth;
                        let finalHeight = pdfWidth / ratio;

                        if (finalHeight > pdfHeight) {
                            finalHeight = pdfHeight;
                            finalWidth = pdfHeight * ratio;
                        }

                        const x = (pdfWidth - finalWidth) / 2;
                        const y = (pdfHeight - finalHeight) / 2;

                        const mimeType = file.type === 'image/jpeg' ? 'JPEG' : 'PNG';

                        doc.addImage(imgData, mimeType, x, y, finalWidth, finalHeight);
                        doc.save(`image-document-${Date.now()}.pdf`);
                        showMessage("PDF generated successfully from image!");
                    };
                    
                    img.onerror = function() {
                        showMessage("Could not load image file.", 'error');
                    };

                } catch (e) {
                    console.error("Image PDF Generation Error:", e);
                    showMessage("Error generating PDF from image.", 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        // --- VIRTUAL KEYBOARD LOGIC ---

        // Function to insert text into the contenteditable div at the caret position
        function insertTextAtCaret(text) {
            textEditor.focus();
            // Use document.execCommand('insertText') which respects the contenteditable state
            document.execCommand('insertText', false, text);
            updateCounts(); // Update counts after insertion
        }

        // Define the Hindi Keyboard Layout
        const hindiLayout = [
            // Row 1: Vowels, Numerals, and Punctuation
            [
                { base: '१', shift: '!', type: 'num' },
                { base: '२', shift: '@', type: 'num' },
                { base: '३', shift: '#', type: 'num' },
                { base: '४', shift: '₹', type: 'num' },
                { base: '५', shift: '%', type: 'num' },
                { base: '६', shift: '^', type: 'num' },
                { base: '७', shift: '&', type: 'num' },
                { base: '८', shift: '*', type: 'num' },
                { base: '९', shift: '(', type: 'num' },
                { base: '०', shift: ')', type: 'num' },
                { base: '-', shift: '_', type: 'num' },
                { base: '=', shift: '+', type: 'num' },
            ],
            // Row 2: Vowels (स्वर) and Matras (मात्रा)
            [
                { base: 'अ', shift: 'आ', type: 'char' },
                { base: 'इ', shift: 'ई', type: 'char' },
                { base: 'उ', shift: 'ऊ', type: 'char' },
                { base: 'ए', shift: 'ऐ', type: 'char' },
                { base: 'ओ', shift: 'औ', type: 'char' },
                { base: 'क', shift: 'ख', type: 'char' },
                { base: 'ग', shift: 'घ', type: 'char' },
                { base: 'ङ', shift: 'ः', type: 'char' }, // Anuswar, Visarg
                { base: '।', shift: '?', type: 'char' }, // Purna Viram
                { base: '[', shift: '{', type: 'char' },
                { base: ']', shift: '}', type: 'char' },
            ],
            // Row 3: Consonants (व्यंजन)
            [
                { base: 'च', shift: 'छ', type: 'char' },
                { base: 'ज', shift: 'झ', type: 'char' },
                { base: 'ञ', shift: 'ट', type: 'char' },
                { base: 'ठ', shift: 'ड', type: 'char' },
                { base: 'ढ', shift: 'ण', type: 'char' },
                { base: 'त', shift: 'थ', type: 'char' },
                { base: 'द', shift: 'ध', type: 'char' },
                { base: 'न', shift: 'ऩ', type: 'char' },
                { base: ';', shift: ':', type: 'char' },
                { base: "'", shift: '"', type: 'char' },
                { base: '\\', shift: '|', type: 'char' },
            ],
            // Row 4: Consonants (व्यंजन) and Modifiers/Punctuation
            [
                { base: 'Shift', shift: 'Shift', type: 'shift' },
                { base: 'प', shift: 'फ', type: 'char' },
                { base: 'ब', shift: 'भ', type: 'char' },
                { base: 'म', shift: 'य', type: 'char' },
                { base: 'र', shift: 'ल', type: 'char' },
                { base: 'व', shift: 'श', type: 'char' },
                { base: 'ष', shift: 'स', type: 'char' },
                { base: 'ह', shift: 'त्र', type: 'char' },
                { base: ',', shift: '<', type: 'char' },
                { base: '.', shift: '>', type: 'char' },
                { base: 'Delete', shift: 'Delete', type: 'delete' },
            ],
            // Row 5: Space and other controls
            [
                { base: 'Alt', shift: 'Alt', type: 'control' },
                { base: 'Enter', shift: 'Enter', type: 'control' },
                { base: ' ', shift: ' ', type: 'space' },
                { base: 'ऽ', shift: 'ॐ', type: 'char' }, // Avagraha, Om
                { base: '॰', shift: '़', type: 'char' }, // Danda, Nukta
                { base: 'Ctrl', shift: 'Ctrl', type: 'control' },
            ]
        ];

        // Function to render the keyboard based on the current shift state
        function renderKeyboard() {
            keyboardDiv.innerHTML = ''; // Clear previous layout

            hindiLayout.forEach((row) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'flex flex-wrap gap-2 mb-2 justify-center';

                row.forEach(keyData => {
                    const keyElement = document.createElement('div');
                    let charToDisplay = isShifted ? keyData.shift : keyData.base;
                    let classList = 'keyboard-key';

                    // Apply specific styling based on key type
                    if (keyData.type === 'control' || keyData.type === 'shift' || keyData.type === 'delete') {
                        classList = 'keyboard-key control-key';
                        // Apply active style to the shift key when active
                        if (keyData.type === 'shift' && isShifted) {
                            classList += ' shift-active';
                        }
                    } else if (keyData.type === 'space') {
                        classList = 'keyboard-key space-key';
                        charToDisplay = 'SPACE';
                    }

                    keyElement.className = classList;
                    keyElement.textContent = charToDisplay;
                    keyElement.dataset.type = keyData.type;

                    // Add click handler
                    keyElement.addEventListener('click', handleKeyPress);
                    rowDiv.appendChild(keyElement);
                });

                keyboardDiv.appendChild(rowDiv);
            });
        }

        // Handler for key clicks
        function handleKeyPress(event) {
            const keyElement = event.currentTarget;
            const type = keyElement.dataset.type;
            const key = keyElement.textContent;

            // Handle control keys
            if (type === 'shift') {
                isShifted = !isShifted; // Toggle shift state
                renderKeyboard(); // Re-render the keyboard
                return;
            } else if (type === 'delete') {
                // Delete logic for contenteditable
                document.execCommand('delete', false, null);
            } else if (type === 'space') {
                insertTextAtCaret(' ');
            } else if (key === 'Enter') {
                insertTextAtCaret('\n'); // Insert a newline
            } else if (type === 'control') {
                // Do nothing for Alt/Ctrl keys
                return;
            } else {
                // Regular character insertion (char, num, etc.)
                insertTextAtCaret(key);
            }

            // After a character is typed, reset shift if it was enabled (like a sticky shift)
            if (isShifted && type !== 'shift') {
                isShifted = false;
                renderKeyboard(); // Re-render to show base characters
            }

            textEditor.focus();
        }

        // Initialize: Enable CSS styling commands and set up event listeners
        window.onload = function() {
            document.execCommand('styleWithCSS', false, true); 
            
            updateCounts();
            updateToolbarState();
            Prism.highlightAll();
            renderKeyboard(); // Initialize the Hindi Keyboard

            document.addEventListener('selectionchange', updateToolbarState); 
            
            // Add a global listener to click outside controls
            document.addEventListener('mousedown', function(event) {
                if (currentImage && !imageControls.contains(event.target) && event.target !== currentImage) {
                    hideImageControls();
                }
            });
            
        }

    </script>

</body>
</html>